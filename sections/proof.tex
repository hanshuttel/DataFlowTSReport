\documentclass[../../master.tex]{subfiles}
\begin{document}
\iffalse
\begin{itemize}
	\item Introduction (what and how)
	\begin{itemize}
		\item What we will go through
		\item What do we mean with the system being sound
		\item How do we compare the system to the semantic (evaluation)
	\end{itemize}
	\item What should we know to prove the soundness of the liveness system
	\item Agreement of the different basis
	\begin{itemize}
		\item What does it mean to aggree
		\item How does $\Gamma$ and $\Upsilon$ aggree with $w$ and $env$?
		\item How does $\Pi$ aggree with the semantics
		\item How does the live type aggree with the semantics?
	\end{itemize}
	\item Soundness of liveness system (theorem
	\begin{itemize}
		\item What and why
		\item How is it good and what does it say
	\end{itemize}
	\item Rewrite the collection semantics
	\begin{itemize}
		\item The pair $(L,V)$ should contain all live locations and variables
	\end{itemize}
\end{itemize}
\fi

\section{Soundness}
In this section we present the soundness of the liveness system with respect to the collection semantics, shown in \cref{App:ColSem}.
The liveness system is sound, if the liveness type contains at least all live occurrences at a given program point.

The liveness system depends on three global bases, one for variable occurrences, for abstract locations, and for an approximation of program points.
To show that these bases are good, we need to define when they agree with the semantic, i.e., to show that the bases overapproximate the dependency function, and that the approximated order of program points is a good approximation.
\bigskip

The tracking of dependencies is handled differently between the liveness system and the semantic.
In the collection semantic, the dependencies of variable and location occurrences are tracked using the $w$ function.
The liveness system need to keep track of dependencies differently, as the notion of locations are purely semantical, throught the global basis for variable occurrences.
To handle locations, the notion of abstract locations is introduced, which is stored in the equivalence basis.
The agreement for occurrence dependencies between the collection semantic and liveness system are as follows:

\begin{definition}{[Agreement of the dependency of occurrences]}
	Let $w$ be the dependency function, $env$ be the environment, $\Gamma$ be the basis for variable occurrences, and $\Upsilon$ be the basis for abstract locations.
	We say that
	$$(w,env)\models(\Gamma,\Upsilon)$$
	Iff
	\begin{enumerate}
		\item $dom(env)\supseteq dom(\Upsilon)$
		\item $\forall x\in dom(\Upsilon). \exists \loc\in\Loc$ such that $env(x)=\loc$
		\item $\forall x^p\in dom(w).w(x^p)=(L^p,V^p)\Rightarrow \Gamma(x^p)=\delta\wedge V^p\subseteq\delta\wedge \Upsilon(x)=\kappa\wedge L^p\subseteq\kappa$
	\end{enumerate}
\end{definition}

The agreement for the occurrence dependencies follows that the dependencies in $w$ should also be defined by $(\Gamma, \Upsilon)$.
The environment, $env$, is introduced here to find which variables are bound to locations.
Since $\Gamma$ and $\Upsilon$ are global, it is sound to only assume that the dependencies in $w$ should be contained in $\Gamma$ and $\Upsilon$, since there can be occurrences not defined in $w$, either by them exisiting in another evaluation branch, or they are not reached yet.
For the pairs, $(w,env)$ and $(\Gamma,\Upsilon)$, to agree it follows that:
\begin{description}
	\item[(1)] Every variable bound by $\Upsilon$ should also be bound by $env$, since $\Upsilon$ should not define any variables that does not exists in $env$.
	\item[(2)] Every variable bound by $\Upsilon$ must be bound to a location in $env$.
	\item[(3)] For all variable occurrence, $x^p$, bound in $w$, the occurrence pair $(L^p,V^p)$ must agree with $\Gamma$ and $\Upsilon$.
		This means that the dependency from $\Gamma(x^p)=\delta$ must be a superset of $V^p$, and the abstract locations obtained from $\Upsilon(x)=\kappa$ must be a superset of $L^p$.
\end{description}

Next follows the agreement between the approximated order of program points, $\Pi$, and the dependency function, $w$.
Here, it is assumed that the order between occurrences can be derived from $w$, since occurrences are only bound to occurences at earlier program points.

\begin{definition}{[Agreement of program order]}
	Let $w$ be the dependency function and $\Pi$ be an approximation of the order of program points, then we say that
	$$w\models\Pi$$
	Iff $\forall u^p\in dom(w).w(u^p)=(L^p,V^p)$, where $u\in(\Var\cup\Loc)$, then
	\begin{enumerate}
		\item if $\loc^q\in L^p$ then $q\sqsubseteq p\in\Pi$
		\item if $y^q\in V^p$ then $q\sqsubseteq p\in\Pi$
	\end{enumerate}
\end{definition}

The agreement of program order defines that, for the order of program points that can be derived from $w$, the global basis must also agree on this order.
Thus, the only program points they agree on are those the dependency function knows about.
This agreement is good, as the only scenarios that is dependent on the program order, in the liveness system, is when to find the closest program point(s) where a reference is written to.
For $w$ and $\Pi$ to agree, it is important that all dependencies for an occurrence, in the domain of $w$, is at an earlier program point, and that $\Pi$ agrees with it.
\bigskip

The last agreement can now be defined, that is, for the liveness type.

\begin{definition}{[Agreement of liveness type and the dependency function]}
	Let $w$ be the dependency function, $env$ be the environment, $\delta$ be a set of possible live variables, $\kappa$ be the abstract locations.
	We say that:
	$$(w,env)\models T$$
	Iff
	\begin{enumerate}
		%\item $dom(w)\supseteq\delta$,
		%\item $dom(w)\supseteq\kappa$,
		\item $\forall x^p\in dom(w)\cap\delta. w(x^p)=(L^p,V^p)\wedge V^p\subseteq\delta$, and
		%\item $\forall \loc^p.\exists x\in\kappa. env(x)=\loc \Rightarrow w(\loc^p)=(L^p,V^p)\wedge L^p\subseteq\kappa$
		\item $\forall x\in\kappa.\exists \loc^p.env(x)=\loc \Rightarrow  w(\loc^p)=(L^p,V^p)$ and $\forall\loc^q\in L^p.\exists y.env(y)=\loc\wedge y\in\kappa$
	\end{enumerate}
\end{definition}

The agreement between the liveness type and $w$ makes sure that if $w$ has bound an occurrence to a possible live occurence, that the liveness type defines to be live, then the liveness type must also contain this occurence.
For the liveness type, $(\delta,\kappa)$, and $w$ to be in agreement, it follows that:
\begin{description}
	\item[(1)] For all the variable occurrences that both are in the domain of $w$ and in $\delta$, then this variable occurrence's variable dependency must also be contained in $\delta$.
	\item[(2)] For all variables, $x$, in $\kappa$, there must exist a location occurrence, $\loc^p$, where $x$ is bound to this location in $env$ where the location occurrence dependencies of $\loc^p$, in $w$, must agree with $\kappa$.
		For a set of location occurrences to agree with $\kappa$, each location occurrence must be bound to a variable, in accordance to $env$, that exists in $\kappa$.
\end{description}

\bigskip
With the agreements defined, we can move on to the soundness for the livenss system.
The liveness system is sound in respect to the collection semantic, that is, the liveness type is an overapproximation of the occurrences in the collection semantic.

\begin{definition}{[Extensions of the dependency function]}
	Let $w$ and $w'$ be two dependency functions.
	We say that $w'$ is an extension of $w$, if for some program point $p$ restricted on $w'$ we get $w$, written as:
	$$w=w'\mid_p$$
	where $p$ is occurrences that $\sqsubseteq p$
\end{definition}

For the liveness system to be sound, it is important to make sure that the three basis agrees with the collection system.
This agreement is done in the following maner, given the a sound agreement before an evaluation, we can show that the agreement is still sound after an evaluation.
Other than the agreement for the three basis, the soundness type must also agree with the semantic, this is done in a similar way.

\begin{lemma}{[Substitution]}
	Suppose that $e^p$ is an occurrence, that 
	$\Gamma,x^{p'}:T_1;\Upsilon;\Pi\vdash e^p:T$ 
	and 
	$\Gamma;\Upsilon;\Pi\vdash v:T_1$.
	Then we have that
	$\Gamma;\Upsilon;\Pi\vdash e^p\begin{Bmatrix} ^v/_x \end{Bmatrix}$
	where $x^{p'}\not\in dom(\Gamma)$.
\end{lemma}

Other than having the agreement, we must also show that the liveness type is a good approximation, i.e., that the liveness type contains at least all used variables.
To show this, we compare the liveness type to the set of variable occurrences.


\begin{theorem}{[Soundness of type system]}
	Suppose $e^p$ is an occurrence where
	\begin{itemize}
		\item $\Gamma,\Upsilon,\Pi\vdash e^p : T$, and 
		\item $env\vdash\left\langle e^p,w,sto,p'\right\rangle\rightarrow\left\langle v,w',sto',L,V,p''\right\rangle$
	\end{itemize}
	and that $(w,env)\models T$ and $(w,env)\models(\Gamma,\Upsilon)$.
	Then we have that:
	\begin{itemize}
		\item $\Gamma,\Upsilon,\Pi\vdash v : T$
		\item $(w',env)\models T$
		\item $(w',env)\models(\Gamma,\Upsilon)$
		\item $(L,V)\models T$
	\end{itemize}
\end{theorem}

\begin{proof}
	The proof proceeds by induction on the height for the derivation tree for $env\vdash\left\langle e^p,w,sto,p'\right\rangle\rightarrow\left\langle v,w,sto,L,V\cup\{x^p\},p\right\rangle$ and $\Gamma,\Upsilon,\Pi\vdash e^p:T$
	Note that the proof follows the rules from the type system.
	First, we consider the base case, where the hight $n=0$.
	Here, there are two rules $[Const]$, $[Var]$:
	\begin{description}
		%Const rule
		\item[$\lbrack Const \rbrack$] By the induction hypothesis for $[Const]$, we know that:
			\begin{itemize}
				\item $\Gamma,\Upsilon,\Pi\vdash c^p :(\emptyset,\emptyset)$,
				\item $env\vdash\left\langle c^p,w,sto,p'\right\rangle\rightarrow\left\langle c,w,sto,(\emptyset,\emptyset),p\right\rangle$
			\end{itemize}
			and that $(w,env)\models(\Gamma,\Upsilon)$ and $(w,env)\models(\delta,\kappa)$.

			By the induction hypothesis we can immediately conclude that $\Gamma,\Upsilon,\Pi\vdash c:(\emptyset,\emptyset)$, $(w',env)\models(\Gamma,\Upsilon)$ and $(w',env)\models(\delta,\kappa)$, where $w'=w$, and $(\emptyset,\emptyset)\models(\emptyset,\emptyset)$

		%Var-r rule
		\item[$\lbrack Var \rbrack$] By the induction hypothesis for $[Var]$, we know that:
			\begin{itemize}
				\item $\Gamma,\Upsilon,\Pi\vdash x^p:T$, where $\Lambda(x,p)=p''$, $\Gamma(x^{p''})=T'$, and $T=T'\cup(\{x^p\},\emptyset)$,
				\item $env\vdash\left\langle x^p,w,sto,p'\right\rangle\rightarrow\left\langle v,w,sto,(L,V\cup\{x^p\}),p\right\rangle$, where $env(x)=v$, $v\neq\loc$, $inf_p(x,w)=p''$, and $w(x^{p''})=(L,V)$,
			\end{itemize}
			and that $(w,env)\models(\Gamma,\Upsilon)$ and $(w,env)\models T$.

			By the induction hypothesis we can immediately conclude that $\Gamma,\Upsilon,\Pi\vdash v:T$ $(w',env)\models(\Gamma,\Upsilon)$ and $(w',env)\models T$, where $w'=w$, and $(L,V\cup\{x^p\})\models T$

\iffalse
		%Var-l rule
		\item[$\lbrack Var-l \rbrack$] By the induction hypothesis for $[Var-l]$, we know that:
			\begin{itemize}
				\item $\Gamma,\Upsilon,\Pi\vdash x^p :(\{x^p\},\kappa)$, where $x\in dom(\Upsilon)$ and $\Upsilon(x)=\kappa$,
				\item $env\vdash\left\langle x^p,w,sto,p'\right\rangle\rightarrow\left\langle v,w,sto,(L,V\cup\{x^p\}),p\right\rangle$, where $env(x)=v$, $v\neq\loc$, $inf_p(x,w)=p''$, and $w(x^{p''})=(L,V)$,
			\end{itemize}
			Where we know that $(w,env)\models(\Gamma,\Upsilon)$ and $(w,env)\models(\delta,\kappa)$ are in agreement.

			We know that no update is done to the dependency function, so we know that $(w,env)\models(\Gamma,\Upsilon)$, and $(w,env)\models(\delta,\kappa)$ still holds after an evaluation.
			Thus, it is immediate to see that the induction hypothesis holds.
\fi
	\end{description}

	In the induction step, assume that $i\leq n$, show for $n+1$:
	\begin{description}
		\item[$\lbrack Let \rbrack$] By the induction hypothesis for $[Let]$, we know that:
			\begin{itemize}
				\item $\Gamma,\Upsilon,\Pi\vdash [\mbox{let}\;x\;e_1^{p'}\;e_2^{p''}]^{p_3}:T$,
				\item $env\vdash\left\langle [\mbox{let}\;x\;e_1^{p'}\;e_2^{p''}]^{p_3},w,sto,p\right\rangle\rightarrow\left\langle v,w',sto',(L,V),p_3\right\rangle$,
			\end{itemize}
			and that $(w,env)\models(\Gamma,\Upsilon)$ and $(w,env)\models(\delta,\kappa)$.

			To conclude the $[let]$ rule, we need to analyse the premises in the collection semantic and type system.
			In the collection semantic, we have the following:
			\begin{figure}[H]
			\setlength\tabcolsep{8pt}
			\begin{tabular}{l}
				\inference[]
				{env\vdash \left\langle e_1^{p'},sto,w,p \right\rangle \rightarrow \left\langle v',sto'',w'',(L',V'),p' \right\rangle &\\
				env[x\mapsto v]\vdash \left\langle e_2^{p''},sto'',w_3,p' \right\rangle \rightarrow \left\langle v,sto',w',(L,V),p'' \right\rangle}
				{env\vdash \left\langle [\mbox{let}\;x\;e_1^{p'}\;e_2^{p''}]^{p_3},sto,w,p \right\rangle \rightarrow \left\langle v,sto',w',(L,V),p_3 \right\rangle}\\
				Where $w_3=w''[x^{p'}\mapsto(L,V)]$\\[1cm]
			\end{tabular}
			\end{figure}
			And in the type system, we have the following:
			\begin{figure}[H]
			\setlength\tabcolsep{8pt}
			\begin{tabular}{l}
				\inference[]
				{\Gamma;\Upsilon;\Pi\vdash e_1^{p'}:T_1 &\\
				\Gamma,x^{p'}:T_1;\Upsilon,\kappa';\Pi\vdash e_2^{p''}:T}
				{\Gamma;\Upsilon;\Pi\vdash [\mbox{let}\; x \; e_1^{p'} \; e_2^{p''}]^{p_3}:T}\\[1cm]
			\end{tabular}
			\end{figure}

			In the first premise, if we know that $(w,env)\models T_1$, then from the induction hypothesis, we can immediately get that $\Gamma;\Upsilon;\Pi\vdash v':T_1$, $(w'',env)\models T_1$, $(w',env)\models(\Gamma,\Upsilon)$, and $(L',V')\models T_1$.
			We only need to know that $(w,env)\models T_1$, where we know by the substitution of the value $v'$ in $e_2^{p''}$, where $v'$ has type $T_1$, we also know that $(w,env)\models T_1$ holds if $x$ is used in $e_2^{p''}$.

			%For $(w,env)\models(\delta',\kappa')$ to hold, we know that if the variable $x$ occures in $e_2^{p''}$, then $\delta'\subseteq\delta$, however, we can't make say the same about $\kappa'$, as if were using the dereferencing for the abstract locations in $\kappa'$, then those will probably not appear in $\kappa$.

			In the second premise, we already know that $(w'',env)\models(\delta,\kappa)$ since we know that $w=w''\mid_p$.
			For the second premise to hold, we also need to show for $env[x\mapsto v]$.
			If we know that $(w'',env[x\mapsto v])\models T$, then by our induction hypothesis we can immediately get $\Gamma,x^{p'}:T_1;\Upsilon,\kappa';\Pi\vdash v:T$, $(w',env[x\mapsto v])\models(\Gamma,x^{p'}:T_1,\Upsilon,\kappa')$, $(w',env[x\mapsto v])\models T$, and $(L,V)\models T$.
			Since $env[x\mapsto v]$ is a local extension, and we know the type and dependencies of $v$, we also know that $(w'',env[x\mapsto v])\models T$.
			From this, the conclusion is immediate.
			
		\item[$\lbrack Let \; rec \rbrack$] ss
		\item[$\lbrack Abs \rbrack$] By the induction hypothesis for $[Abs]$, we know that:
			\begin{itemize}
				\item $\Gamma,\Upsilon,\Pi\vdash [\lambda x.e^{p'}]^{p''}:T_1\rightarrow T_2$.
				\item $env\vdash\left\langle [\lambda x.e^{p'}]^{p''},w,sto,p\right\rangle\rightarrow\left\langle v,w,sto,(\emptyset,\emptyset),p''\right\rangle$, where $v=\left\langle x, e^{p'}, env \right\rangle$
			\end{itemize}
			and that $(w,env)\models(\Gamma,\Upsilon)$ and $(w,env)\models T_1\rightarrow T_2$.

			From the induction hypothesis we immediately get that $(w',env)\models(\Gamma,\Upsilon)$ and $(w',env)\models T_1\rightarrow T_2$, where $w'=w$, and that $(\emptyset,\emptyset)\models T_1\rightarrow T_2$.
			We need to show that $\Gamma;\Upsilon;\Pi\vdash \left\langle x, e^{p'}, env \right\rangle:T_1\rightarrow T_2$.
			We know from the premise of the $[Abs]$ type rule that $\Gamma,x^{p''}:T_1;\Upsilon;\Pi\vdash e^{p'}:T_2$, where $p''\sqsubseteq p'\in\Pi$.
			To show that $\left\langle x, e^{p'}, env \right\rangle$ has type $T_1\rightarrow T_2$, we need to show that for any $v_1^{p_1}:T_1$ we have that $\Gamma,\Upsilon,\Pi\vdash e\{x/v_1\} : T_2\{x/T_1\}$.

			By lemma (insert ref to substitution lemma), we know that if $v_1$ has type $T_1$, the the substition holds.


		\item[$\lbrack App \rbrack$] By the induction hypothesis for $[App]$, we know that:
			\begin{itemize}
				\item $\Gamma,\Upsilon,\Pi\vdash [e_1^{p'}\;e_2^{p'}]^{p_3}:T$
				\item $env\vdash\left\langle [e_1^{p'}\;e_2^{p'}]^{p_3},w,sto,p\right\rangle\rightarrow\left\langle v,w',sto',(L,V),p_3\right\rangle$
			\end{itemize}
			and that $(w,env)\models(\Gamma,\Upsilon)$ and $(w,env)\models T$.

			To conclude the $[App]$ we need to analyse the premises in the collection semantics and type system.
			In the collection semantics, we have the following:
			\begin{figure}[H]
			\setlength\tabcolsep{8pt}
			\begin{tabular}{l}
				\inference[]
				{env\vdash \left\langle e_1^{p'},sto,w,p \right\rangle \rightarrow \left\langle v',sto'',w'',(L',V'),p' \right\rangle &\\
				env\vdash \left\langle e_2^{p''},sto'',w'',p' \right\rangle \rightarrow \left\langle v'',sto_3,w_3,(L,V),p'' \right\rangle &\\
				env'[x\mapsto v'']\vdash \left\langle e_2^{p''},sto_3,w_3,p' \right\rangle \rightarrow \left\langle v',sto',w',(L,V),p_1 \right\rangle}
				{env\vdash \left\langle [e_1^{p'}\;e_2^{p''}]^{p_3},sto,w,p \right\rangle \rightarrow \left\langle v,sto',w',(L,V),p_3 \right\rangle}\\
				Where $v=\left\langle x,e^{p_1},env'\right\rangle$\\[1cm]
			\end{tabular}
			\end{figure}

			And in the type system we have the following
			\begin{figure}[H]
			\setlength\tabcolsep{8pt}
			\begin{tabular}{l}
				\inference[]
				{\Gamma;\Upsilon;\Pi\vdash e_1^{p'}:T_1\rightarrow T &\\
				\Gamma;\Upsilon;\Pi\vdash e_2^{p''}:T_1}
				{\Gamma;\Upsilon;\Pi\vdash [e_1^{p'} \; e_2^{p''}]^{p_3}:T}\\[1cm]
			\end{tabular}
			\end{figure}

			Then, in the first premise we have the type $T_1\rightarrow T$, and in the semantics we know that the value it evaluates to is $\left\langle x,e^{p_1},env' \right\rangle$, thus we know that $\Gamma;\Upsilon;\Pi\vdash v_1:T_1\rightarrow T$ where $v_1=[\lambda x.e^{p_1}]$.
			Furthermore, from the second premise we know that the type must be $T_1$, thuse $\Gamma;\Upsilon;\Pi\vdash v_2:T_1$.
			From lemma (insert here), we then know that we can conclude the type by substition, and get $\Gamma;\Upsilon;\Pi\vdash e^{p_1}\begin{Bmatrix} ^{v_2}/_x \end{Bmatrix}$

		\item[$\lbrack App \; const \rbrack$] ss
		\item[$\lbrack App \; rec \rbrack$] ss
		\item[$\lbrack Loc \; new \rbrack$] By the induction hypothesis for $[Loc\;new]$, we know that:
			\begin{itemize}
				\item $\Gamma,\nu x:T;\Upsilon,\kappa;\Pi\vdash [\mbox{ref}\;e^{p'}]^{p''}:(\emptyset,\{\kappa\})$, 
				\item $env\vdash\left\langle [\mbox{ref}\;e^{p'}]^{p''},w,sto,p\right\rangle\rightarrow\left\langle \loc,w',sto',(\{\loc^{p''}\},\emptyset),p''\right\rangle$
			\end{itemize}
			and that $(w,env)\models(\Gamma,\Upsilon)$ and $(w,env)\models (\emptyset,\kappa)$.

			To conclude, we need to first analyse the premises, where in the collection semantics we have:
			\begin{figure}[H]
			\setlength\tabcolsep{8pt}
			\begin{tabular}{l}
				\inference[]
				{env\vdash \left\langle e^{p'},sto,w,p \right\rangle \rightarrow \left\langle v',sto'',w'',(L,V),p' \right\rangle}
				{env\vdash \left\langle [\mbox{ref}\;e^{p'}]^{p''},sto,w,p \right\rangle \rightarrow \left\langle v,sto',w',(\{\loc^{p''}\},\emptyset),p_3 \right\rangle}\\[0.5cm]
				Where $v=\loc$, $sto'=sto''[next\mapsto \loc]$ and $w'=w''[\loc^{p''}\mapsto(L,V)]$\\
			\end{tabular}
			\end{figure}

			And in the type system we have the following
			\begin{figure}[H]
			\setlength\tabcolsep{8pt}
			\begin{tabular}{l}
				\inference[]
				{\Gamma;\Upsilon;\Pi\vdash e^{p'}:(\delta',\kappa')}
				{\Gamma,\nu x^{p'}:T;\Upsilon,\kappa;\Pi\vdash [\mbox{ref}\;e^{p'}]^{p''}:(\emptyset,\{\kappa\})}\\[0.5cm]
				Where $\kappa=\{\nu x\}$
			\end{tabular}
			\end{figure}

			\todo[inline]{Figure out how to conclude the premise}
			Then, from the first premise, if we know that $(w,env)\models(\delta',\kappa')$, then we immediately get $\Gamma;\Upsilon;\Pi\vdash v':(\delta',\kappa')$, $(w',env)\models(\delta',\kappa')$, $(w',env)\models(\Gamma,\Upsilon)$, and $(L,V)\models(\delta',\kappa')$.

			From the induction hypothesis we know that the type of $v$ must be $\Gamma;\Upsilon;\Pi\vdash v:(\emptyset,\kappa)$.
			We can immediately conclude that $(w'',env)\models(\emptyset,\{\kappa\}$, $(w'',env)\models(\Gamma,\nu x:(\delta',\kappa'))$.
			Lastly, we can conclude $(L,\emptyset)\models(\emptyset,\kappa)$, since $\nu x$ is an internal variable that represents a location.



		\item[$\lbrack Loc \; read \rbrack$] By the induction hypothesis for $[Loc\;read]$, we know that:
			\begin{itemize}
				\item $\Gamma,\Upsilon,\Pi\vdash [!e^{p'}]^{p''}:T$
				\item $env\vdash\left\langle [!e^{p'}]^{p''},w,sto,p\right\rangle\rightarrow\left\langle v,w,sto,(L,V),p''\right\rangle$
			\end{itemize}
			and that $(w,env)\models(\Gamma,\Upsilon)$ and $(w,env)\models T$.

			To conclude, we need to first analyse the premises, where in the collection semantics we have:
			\begin{figure}[H]
			\setlength\tabcolsep{8pt}
			\begin{tabular}{l}
				\inference[]
				{env\vdash \left\langle e^{p'},sto,w,p \right\rangle \rightarrow \left\langle v',sto',w',(L,V),p' \right\rangle}
				{env\vdash \left\langle [!e^{p'}]^{p''},sto,w,p \right\rangle \rightarrow \left\langle v,sto',w',(L\cup L'\cup\{\loc^{p''}\},V\cup V'),p'' \right\rangle}\\[0.5cm]
				Where $v'=\loc$ $sto'(\loc)=v$, $p_3=inf_p{\loc,w}$, and $w(\loc^{p_3})=(L',V')$
			\end{tabular}
			\end{figure}

			And in the type system we have the following
			\begin{figure}[H]
			\setlength\tabcolsep{8pt}
			\begin{tabular}{l}
				\inference[]
				{\Gamma;\Upsilon;\Pi\vdash e^{p'}:(\delta',\kappa')}
				{\Gamma;\Upsilon;\Pi\vdash [\mbox{ref}\;e^{p'}]^{p''}:T}\\[0.5cm]
				Where $T=T'\cup(\delta',\kappa')$, \\$T'=\bigcup_{[\tilde{x}]\in\kappa}(\Gamma(\nu x^{p_3})\cup\{\nu x^{p''}\})$, \\$\nu x\in[\tilde{x}]$, and $p_3=\Lambda(x,p')$.
			\end{tabular}
			\end{figure}

			From the premise, if we know that $(w,env)\models(\delta',\kappa')$ we can immediately get that $\Gamma;\Upsilon;\Pi\vdash v':(\delta',\kappa')$, $(w',env)\models(\delta',\kappa')$, $(w',env)\models(\Gamma,\Upsilon)$, and $(L,V)\models(\delta',\kappa')$.
			We already know that $(\delta',\kappa')$ is a part of $T$ from the side condition, thus we already know that $(w,env)\models(\delta',\kappa')$.

			From this, the conclusion follows immediately, since we also get that $\Gamma;\Upsilon;\Pi\vdash v:T$, $(w',env)\models T$, $(w',env)\models(\Gamma,\Upsilon)$, and $(L,V)\models T$.

		\item[$\lbrack Loc \; write \rbrack$] By the induction hypothesis for $[Var]$, we know that:
			\begin{itemize}
				\item $\Gamma,\Upsilon,\Pi\vdash x^p:T$, where $\Lambda(x,p)=p''$, $\Gamma(x^{p''})=T'$, and $T=T'\cup(\{x^p\},\emptyset)$,
				\item $env\vdash\left\langle x^p,w,sto,p'\right\rangle\rightarrow\left\langle v,w,sto,(L,V\cup\{x^p\}),p\right\rangle$, where $env(x)=v$, $v\neq\loc$, $inf_p(x,w)=p''$, and $w(x^{p''})=(L,V)$,
			\end{itemize}
			and that $(w,env)\models(\Gamma,\Upsilon)$ and $(w,env)\models T$.


		\item[$\lbrack Case \; match \rbrack$] ss
		\item[$\lbrack Case \; fail \rbrack$] ss
		\item[$\lbrack Case \; \epsilon \rbrack$] ss
	\end{description}
\end{proof}

\iffalse
\begin{theorem}{[Test 1]}
	If $(w,env)\models(\delta,\kappa)$ and $(w,env)\models(\Gamma,\Upsilon)$ holds in
	\begin{itemize}
		\item $\Gamma,\Upsilon,\Pi\vdash e^p : (\delta,\kappa)$, and 
		\item $env\vdash\left\langle e^p,w,sto,p'\right\rangle\rightarrow\left\langle v,w',sto',L,V,p''\right\rangle$.
	\end{itemize}
	Then $(w',env)\models(\Gamma,\Upsilon)$, $(w',env)\models(\delta,\kappa)$, $L\subseteq\kappa$, and $V\subseteq\delta$ also holds.
\end{theorem}

\begin{theorem}{[Test 2]}
	Suppose $(w,env)\models(\delta,\kappa)$ and $(w,env)\models(\Gamma,\Upsilon)$ agrees in
	\begin{itemize}
		\item $\Gamma,\Upsilon,\Pi\vdash e^p : (\delta,\kappa)$, and 
		\item $env\vdash\left\langle e^p,w,sto,p'\right\rangle\rightarrow\left\langle v,w',sto',L,V,p''\right\rangle$.
	\end{itemize}
	for some occurrence $e^p$.
	Then $(w',env)\models(\Gamma,\Upsilon)$, $(w',env)\models(\delta,\kappa)$, $L\subseteq\kappa$, and $V\subseteq\delta$ still holds after the evaluation of $e^p$.
\end{theorem}

\begin{theorem}{[Test 3]}
	Suppose $e^p$ is an occurrence and that
	\begin{itemize}
		\item $\Gamma,\Upsilon,\Pi\vdash e^p : (\delta,\kappa)$, and 
		\item $env\vdash\left\langle e^p,w,sto,p'\right\rangle\rightarrow\left\langle v,w',sto',L,V,p''\right\rangle$
	\end{itemize}
	where $(w,env)\models(\delta,\kappa)$ and $(w,env)\models(\Gamma,\Upsilon)$ are in agreement.
	Then also $(w',env)\models(\Gamma,\Upsilon)$ and $(w',env)\models(\delta,\kappa)$ are in agreement, and $L\subseteq\kappa$ and $V\subseteq\delta$ holds.
\end{theorem}
\fi
\end{document}
