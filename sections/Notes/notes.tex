\documentclass[../../master.tex]{subfiles}
\begin{document}
\section{Notes}

\subsection{Free and bound variables}
We denote $\tau(s)$, for a pattern $s$, as
$$
	\tau(s)=
		\left\{\begin{matrix}
			\{x\} & \mbox{if}\;s=x\\ 
			\emptyset & \mbox{otherwise}
		\end{matrix}\right.
$$

\begin{definition}[Free variables]
	The set of free variables is given by:
	\begin{align*}
		fv(x^p)&=\{x\}\\
		fv(c^p)&=\emptyset\\
		fv([\lambda\;y.e_1^{p'}]^p)&=fv(e_1^{p'})\cup fv(e_2^{p''})\backslash\{y\}\\
		fv([e_1^{p'}\;e_2^{p''}]^p)&=fv(e_1^{p'})\cup fv(e_2^{p''})\\
		fv([\mbox{let}\;y\;e_1^{p'}\;e_2^{p''}]^p)&=fv(e_1^{p'})\cup fv(e_2^{p''})\backslash\{y\}\\
		fv([\mbox{let rec}\;f\;e_1^{p'}\;e_2^{p''}]^p)&=fv(e_1^{p'})\cup fv(e_2^{p''})\backslash\{f\}\\
		fv([\mbox{case}\;e^{p'}\;\pi^{p''}]^p)&=fv(e_1^{p'})\cup fv(\pi)\\
		fv([(s\;e^{p'})\;\pi])&=fv(e^{p'})\cup fv(\pi)\backslash\tau(s)\\
		fv([(s\;e^{p'})])&=fv(e^{p'})\backslash\tau(s)\\
		fv([\mbox{ref}\;e^{p'}]^p)&=fv(e^{p'})\\
		fv([!e^{p'}]^p)&=fv(e^{p'})\\
		fv([e_1^{p'}\;:=\;e_2^{p''}]^p)&=fv(e_1^{p'})\cup fv(e_2^{p''})\\
	\end{align*}
\end{definition}

\begin{definition}[Bound variables]
	The set of bound variables is given by:
	\begin{align*}
		bv(x^p)&=\emptyset\\
		bv(c^p)&=\emptyset\\
		bv([\lambda\;y.e_1^{p'}]^p)&=bv(e_1^{p'})\cup bv(e_2^{p''})\cup\{y\}\\
		bv([e_1^{p'}\;e_2^{p''}]^p)&=bv(e_1^{p'})\cup bv(e_2^{p''})\\
		bv([\mbox{let}\;y\;e_1^{p'}\;e_2^{p''}]^p)&=bv(e_1^{p'})\cup bv(e_2^{p''})\cup\{y\}\\
		bv([\mbox{let rec}\;f\;e_1^{p'}\;e_2^{p''}]^p)&=bv(e_1^{p'})\cup bv(e_2^{p''})\cup\{f\}\\
		bv([\mbox{case}\;e^{p'}\;\pi^{p''}]^p)&=bv(e_1^{p'})\cup bv(\pi)\\
		bv([(s\;e^{p'})\;\pi])&=bv(e^{p'})\cup bv(\pi)\cup\tau(s)\\
		bv([(s\;e^{p'})])&=bv(e^{p'})\cup\tau(s)\\
		bv([\mbox{ref}\;e^{p'}]^p)&=bv(e^{p'})\\
		bv([!e^{p'}]^p)&=bv(e^{p'})\\
		bv([e_1^{p'}\;:=\;e_2^{p''}]^p)&=bv(e_1^{p'})\cup bv(e_2^{p''})\\
	\end{align*}
\end{definition}


\subsection{Basis}
This section introduces the basis for the type checker, as such the type bases er assumptions.
\begin{definition}[Type Base for aliasing]
	The type base $\kappa^0$ is a partition of $\cat{Var}\cup\cat{IVar}$, such that:
	$$\cat{Var}\subseteq\bigcup_{i\in I}(\kappa_i^0)$$
	and that $\kappa_i^0\neq\kappa_j^0$ for all $i\neq j$
\end{definition}
The type base for aliasing is an assumption for which variables that shares the same internal variable, and as such, shares the same location.
As such, if we have a an assumption for a variable $x$, such that $\{x\}=\kappa_i$, then $x$ would not be an alias to a location.
On the otherhand if we have $\{y,\nu y\}=\kappa_j$, for a variable $y$ and internal variable $\nu y$, then $y$ is an alias for $\nu y$.

\subsection{Type environment}
\begin{definition}[Type Environment]
	A type environment $\Gamma$ is a partial function $\Gamma:Id^P\rightharpoonup TYPES$
\end{definition}
As such, $\Gamma$ represents the dependencies for variables and internal variables.

\begin{definition}[Approximated order of program points]
	An approximated order of program points $\Pi$, such that: 
	\begin{itemize}
		\item  $p\sqsubseteq p'\in\Pi$
		\item The order of program points is transitive, such that if $p\sqsubseteq p'\in\Pi$ and $p'\sqsubseteq p''\in\Pi$ then $p\sqsubseteq p''\in\Pi$.
	\end{itemize}
\end{definition}
The intuition behind an approximated order of program points is the execution order, and should as such follow all possible evaluation paths for a given program.

\subsection{Agreement}
\begin{definition}[Environment agreement]\label{def:EnvAgree}
	Let $w$ be a dependency function, $env$ be an environment, and $\Gamma$ be a type environment.
	We say that:
	$$(w,env)\models\Gamma$$
	if 
	\begin{itemize}
		\item $\forall x^p\in dom(w).x^p\in dom(\Gamma)\Rightarrow w(x^p)=(L,V)\wedge\Gamma(x^p)=T.(w,env,(L,V))\models T$
		\item $\forall \loc^p \in dom(w).\exists\nu x^{p'}\in dom(\Gamma)\Rightarrow w(\loc^p)=(L,V)\wedge\Gamma(\nu x^{p'})=T.(w,env,(L,V))\models T$
	\end{itemize}
\end{definition}

\begin{definition}[Type agreement]
	Let $w$ be a dependency function, $env$ be an environment, $(L,V)$ be a dependency pair, and $T$ be a type.
	We say that:
	$$(w,env,(L,V))\models T$$
	if
	\begin{itemize}
		\item $T=T_1\rightarrow T_2$ then:
		\begin{itemize}
			\item $(w,env,(L,V))\models T_1\Rightarrow(w,env,(L,V))\models T_2$
		\end{itemize}
		\item $T=(\delta,\kappa)$ then:
		\begin{itemize}
			\item $(env,(L,V))\models\delta$
			\item $(w,env)\models\kappa$
		\end{itemize}
	\end{itemize}
\end{definition}

\begin{definition}[Dependency agreement]
	Let $env$ be an environment, $(L,V)$ be a dependency pair, and $\delta$ be a set of variables.
	We say that:
	$$(env,(L,V))\models\delta$$
	if
	\begin{itemize}
		\item $V\subseteq\delta$,
		\item For all $\loc^p\in L$ where $\exists x\in dom(env).env(x)=\loc$, we then have $\{x\in dom(env)\mid env(x)=\loc\}\subseteq \kappa_i^0$ for a $\kappa_i^0\in\delta$
		\item For all $\loc^p\in L$ where $\not\exists x \in dom(env).env(x)=\loc$ then there exists a $\kappa_i^0\in\delta$ such that $\kappa_i^0\subseteq\cat{IVar}$
	\end{itemize}
\end{definition}

\begin{definition}[Alias agreement]
	Let $env$ be an environment, and $\kappa$ be an alias set.
	We say that:
	$$(env,(L,V))\models\kappa$$
	if
	\begin{itemize}
		\item For all $\loc^p\in dom(w)$ where $\exists x\in dom(env).env(x)=\loc$, we then have $\{x\in dom(env)\mid env(x)=\loc\}\subseteq \kappa_i^0$ for a $\kappa_i^0\in\kappa$
		\item For all $\loc^p\in dom(w)$ where $\not\exists x \in dom(env).env(x)\neq\loc$ then there exists a $\kappa_i^0\in\kappa$ such that $\kappa_i^0\subseteq\cat{IVar}$
	\end{itemize}
\end{definition}

\subsection{Judgement}
\begin{definition}[Environment judgement]
	Let $env$ be an environment, $\Gamma$ be a type environment, and $\Pi$ be the approximated order of program points.
	We say that:
	$$\Gamma;\Pi\vdash env$$
	if 
	\begin{itemize}
		\item For all $x\in dom(env)$ and for all $x^p\in dom(\Gamma).\Gamma(x^p)=T_x$ then 
			$$\Gamma,\Pi\vdash env(x):T_x$$
	\end{itemize}
\end{definition}

\subsection{Type rules for values}
\begin{figure}[H]
	\setlength\tabcolsep{8pt}
	\begin{tabular}{l}
		\hline\\
		\runa{Constant}\\[0.4cm]
			\inference[]{}
				{\Gamma;\Pi\vdash  c:(\emptyset, \emptyset)}\\[1cm]

		\runa{Location}\\[0.4cm]
			\inference[]{}
				{\Gamma;\Pi\vdash  \loc:(\delta, \kappa)}\\[1cm]

		\runa{Closure}\\[0.4cm]
			\inference[]
				{
					\Gamma;\Pi\vdash env \\
					\Gamma,x^{p}:T_1;\Pi\vdash e^{p'}:T_2
				}
				{\Gamma;\Pi\vdash \left\langle x^{p}, e^{p'}, env \right\rangle^{p''}:T_1\rightarrow T_2}\\[1cm]

		\runa{Recursive closure}\\[0.4cm]
			\inference[]
				{
					\Gamma;\Pi\vdash env \\
					\Gamma,x^{p}:T_1,f^{p'}:T_1\rightarrow T_2;\Pi\vdash e^{p''}:T_2
				}
				{\Gamma;\Pi\vdash \left\langle x^{p}, f^{p'}, e^{p''}, env \right\rangle^{p_3}:T_1\rightarrow T_2}\\[1cm]

		\runa{Unit}\\[0.4cm]
			\inference[]{}
			{\Gamma;\Pi\vdash  ():(\delta, \kappa)}\\[0.5cm]
		\hline
	\end{tabular}
	\caption{Type rules for values}
	\label{fig:ValTypeRules}
\end{figure}

\subsection{Proof}
\iffalse
\begin{definition}[Substitutions]
	Suppose $e^p$ is an occurrence, then we say that
	$$e^p[x\mapsto v]$$
	is a substitution of $v$ for all occurrences of the variable $x$ on the structure of $e^p$ defined by:
	\begin{align*}
		c^p[x\mapsto v]&=c^p\\
		x^p[x\mapsto v]&=	\left\{\begin{matrix}
									y & \mbox{if}\;y \neq x\\ 
									v & \mbox{if}\;y = x\\ 
								\end{matrix}\right.\\
		[\lambda\;y\;e_1^{p'}]^p[x\mapsto v]&=
			\left\{\begin{matrix}
				[\lambda\;y\;e_1^{p'}]^p & \mbox{if}\;y = x\\ 
				[\lambda\;y\;e_1^{p'}[x\mapsto v]]^p & \mbox{if}\;y \neq x\\
			\end{matrix}\right.\\
		[e_1^{p'}\;e_2^{p''}]^p[x\mapsto v]&=[e_1^{p'}[x\mapsto v]\;e_2^{p''}[x\mapsto v]]^p\\
		[\mbox{let}\;y\;e_1^{p'}\;e_2^{p''}]^p[x\mapsto v]&=	
			\left\{\begin{matrix}
				[\mbox{let}\;y\;e_1^{p'}\;e_2^{p''}]^p & \mbox{if}\;y = x\\ 
				[\mbox{let}\;y\;e_1^{p'}[x\mapsto v]\;e_2^{p''}[x\mapsto v]]^p & \mbox{if}\;y \neq x\\ 
			\end{matrix}\right.\\
		[\mbox{let rec}\;f\;e_1^{p'}\;e_2^{p''}]^p[x\mapsto v]&=
			\left\{\begin{matrix}
				[\mbox{let rec}\;f\;e_1^{p'}\;e_2^{p''}]^p & \mbox{if}\;f = x\\ 
				[\mbox{let rec}\;f\;e_1^{p'}[x\mapsto v]\;e_2^{p''}[x\mapsto v]]^p & \mbox{if}\;f \neq x\\ 
			\end{matrix}\right.\\
		[\mbox{case}\;e^{p'}\;\pi^{p''}]^p[x\mapsto v]&=[\mbox{case}\;(e^{p'}[x\mapsto v])\;(\pi[x\mapsto v])]^p\\
		[\mbox{ref}\;e^{p'}]^p[x\mapsto v]&=[\mbox{ref}\;(e^{p'}[x\mapsto v])]^p\\
		[!e^{p'}]^p[x\mapsto v]&=[!(e^{p'}[x\mapsto v])]^p\\
		[e_1^{p'}\;:=\;e_2^{p''}]^p[x\mapsto v]&=[e_1^{p'}[x\mapsto v]\;e_2^{p''}[x\mapsto v]]^p\\
	\end{align*}
\end{definition}

\begin{definition}[Pattern substitutions]
	Suppose $\pi$ is patterns construct, we say that
	$$\pi[x\mapsto v]$$
	is a substitution of $v$ for all occurrences of the variable $x$ on the structure of $\pi$ defined by:
	\begin{align*}
		[(s\;e^{p'})\;\pi][x\mapsto v]&=[(s\;(e^{p'}[x\mapsto v]))\;(\pi[x\mapsto v])]\\
		[(s\;e^{p'})][x\mapsto v]&=[(s\;(e^{p'}[x\mapsto v]))]\\
	\end{align*}
\end{definition}

\todo[inline]{The type substitution lemma only works for placeholder variables and not internal variables, which is a bit of a problem. To handle internal variables, the value $v$ should be changed when meeting a \runa{Ref write} operation, and the substitution should be on \runa{Ref read}. This can be usefull to explain the \runa{Ref} and \runa{Ref write} rules as they extend upon the global $\Gamma$}
\begin{lemma}[Type substitution]
	Suppose that $q$ is either an occurrence, $e^p$, or a pattern $(s\;e^p)$, that 
	$\Gamma,x^{p'}:T_1;\Pi\vdash q:T$
	and 
	$\Gamma;\Pi\vdash v:T_1$.
	Then we have that
	$\Gamma;\Pi\vdash q\begin{Bmatrix} ^v/_x \end{Bmatrix}$
	where $x^{p'}\not\in dom(\Gamma)$.
\end{lemma}

\begin{proof}
	The proof proceeds by induction on the height for the derivation tree of the judgement $\Gamma,\Pi\vdash q:T$.
	
	In the base case we have the \runa{Cons} and \runa{Var} rule:
	\begin{description}
		\item[\runa{Cons}] Here $q=c^p$, since $c^p\begin{Bmatrix} ^v/_x \end{Bmatrix}=c^p$ and we have $\Gamma;\Pi\vdash v:(\emptyset,\emptyset)$ this case follows immediately.

		\item[\runa{Var}] Here $q=x^p$, since $x^p\begin{Bmatrix} ^v/_x \end{Bmatrix}=v$ and we have $\Gamma;\Pi\vdash v:T$ this case follows immediately.
	\end{description}

	Next, follows the induction step:
	\begin{description}
		\item[\runa{Abs}] Here $q=[\lambda\;y\;e_1^{p'}]^p$, $x\neq y$, and $q\begin{Bmatrix} ^v/_x \end{Bmatrix}=[\lambda\;y\;e_1^{p'}]^p\begin{Bmatrix} ^v/_x \end{Bmatrix}$.
			By the induction hypothesis, we have $\Gamma,y:T_1;\Pi\vdash e_1^{p'}\begin{Bmatrix} ^v/_x \end{Bmatrix}$ where $x\notin dom(\Gamma)$.
			By using \runa{Abs}, we get $[\lambda\;y\;e_1^{p'}]^p\begin{Bmatrix} ^v/_x \end{Bmatrix}$

		\item[\runa{App}] Here $q=[e_1^{p'}\;e_2^{p''}]^p$ and $q\begin{Bmatrix} ^v/_x \end{Bmatrix}=[e_1^{p'}\;e_2^{p''}]^p\begin{Bmatrix} ^v/_x \end{Bmatrix}$.
			By the induction hypothesis, we have $\Gamma;\Pi\vdash e_1^{p'}\begin{Bmatrix} ^v/_x \end{Bmatrix}$ and $\Gamma;\Pi\vdash e_2^{p''}\begin{Bmatrix} ^v/_x \end{Bmatrix}$ where $x\notin dom(\Gamma)$.
			By using \runa{App}, we get $[e_1^{p'}\;e_2^{p''}]^p\begin{Bmatrix} ^v/_x \end{Bmatrix}$

		\item[\runa{Let-1}] Here $q=[\mbox{let}\;y\;e_1^{p'}\;e_2^{p''}]^p$, $x\neq y$, and $q\begin{Bmatrix} ^v/_x \end{Bmatrix}=[\mbox{let}\;y\;e_1^{p'}\;e_2^{p''}]^p\begin{Bmatrix} ^v/_x \end{Bmatrix}$.
			By the induction hypothesis, we have $\Gamma;\Pi\vdash e_1^{p'}\begin{Bmatrix} ^v/_x \end{Bmatrix}$ and $\Gamma,y:(\delta,\kappa\cup\{y\});\Pi\vdash e_2^{p''}\begin{Bmatrix} ^v/_x \end{Bmatrix}$ where $x\notin dom(\Gamma)$.
			By using \runa{Let-1}, we get $[\mbox{let}\;y\;e_1^{p'}\;e_2^{p''}]^p\begin{Bmatrix} ^v/_x \end{Bmatrix}$

		\item[\runa{Let-2}] Here $q=[\mbox{let}\;y\;e_1^{p'}\;e_2^{p''}]^p$, $x\neq y$, and $q\begin{Bmatrix} ^v/_x \end{Bmatrix}=[\mbox{let}\;y\;e_1^{p'}\;e_2^{p''}]^p\begin{Bmatrix} ^v/_x \end{Bmatrix}$.
			By the induction hypothesis, we have $\Gamma;\Pi\vdash e_1^{p'}\begin{Bmatrix} ^v/_x \end{Bmatrix}$ and $\Gamma,y:T_1;\Pi\vdash e_2^{p''}\begin{Bmatrix} ^v/_x \end{Bmatrix}$ where $x\notin dom(\Gamma)$.
			By using \runa{Let-2}, we get $[\mbox{let}\;y\;e_1^{p'}\;e_2^{p''}]^p\begin{Bmatrix} ^v/_x \end{Bmatrix}$

		\item[\runa{Let rec}] Here $q=[\mbox{let rec}\;f\;e_1^{p'}\;e_2^{p''}]^p$, $x\neq y$, and $q\begin{Bmatrix} ^v/_x \end{Bmatrix}=[\mbox{let rec}\;f\;e_1^{p'}\;e_2^{p''}]^p\begin{Bmatrix} ^v/_x \end{Bmatrix}$.
			By the induction hypothesis, we have $\Gamma;\Pi\vdash e_1^{p'}\begin{Bmatrix} ^v/_x \end{Bmatrix}$ and $\Gamma,f:T_1\rightarrow T_2;\Pi\vdash e_2^{p''}\begin{Bmatrix} ^v/_x \end{Bmatrix}$ where $x\notin dom(\Gamma)$.
			By using \runa{Let rec}, we get $[\mbox{let}\;y\;e_1^{p'}\;e_2^{p''}]^p\begin{Bmatrix} ^v/_x \end{Bmatrix}$

		\item[\runa{Case}] Here $q=[\mbox{case}\;e^{p'}\;\vec{\pi}]^p$, and $q\begin{Bmatrix} ^v/_x \end{Bmatrix}=[\mbox{case}\;e^{p'}\;\vec{\pi}]^p\begin{Bmatrix} ^v/_x \end{Bmatrix}$.
			By the induction hypothesis, we have $\Gamma;\Pi\vdash e^{p'}\begin{Bmatrix} ^v/_x \end{Bmatrix}$ and $\sigma(\Gamma,s_i,p',T');\Pi\vdash (s_i\;e_i^{p'})\begin{Bmatrix} ^v/_x \end{Bmatrix}$ for each $1\leq i \leq |\vec{\pi}|$, and where $x\notin dom(\Gamma)$.
			By using \runa{Case}, we get $[\mbox{case}\;e^{p'}\;\vec{\pi}]^p\begin{Bmatrix} ^v/_x \end{Bmatrix}$

		\item[\runa{Match}] Here $q=(s\;e^{p'})$, $s\neq x$, and $q\begin{Bmatrix} ^v/_x \end{Bmatrix}=(s\;e^{p'})\begin{Bmatrix} ^v/_x \end{Bmatrix}$.
		By the induction hypothesis, we have $\Gamma;\Pi\vdash e^{p'}\begin{Bmatrix} ^v/_x \end{Bmatrix}$, where $x\notin dom(\Gamma)$.
		By using \runa{Match}, we get $(s\;e^{p'})\begin{Bmatrix} ^v/_x \end{Bmatrix}$.

		\item[\runa{Ref}] Here $q=[\mbox{ref}\;e^{p'}]^{p}$ and $q\begin{Bmatrix} ^v/_x \end{Bmatrix}=[\mbox{ref}\;e^{p'}]^{p}\begin{Bmatrix} ^v/_x \end{Bmatrix}$.
		By the induction hypothesis, we have $\Gamma;\Pi\vdash e^{p'}\begin{Bmatrix} ^v/_x \end{Bmatrix}$, where $x\notin dom(\Gamma)$.
		By using \runa{Ref}, we get $[\mbox{ref}\;e^{p'}]^{p}\begin{Bmatrix} ^v/_x \end{Bmatrix}$.


		\item[\runa{Ref read}] Here $q=[!e^{p'}]^{p}$, and $q\begin{Bmatrix} ^v/_x \end{Bmatrix}=[!e^{p'}]^{p}\begin{Bmatrix} ^v/_x \end{Bmatrix}$.
		By the induction hypothesis, we have $\Gamma;\Pi\vdash e^{p'}\begin{Bmatrix} ^v/_x \end{Bmatrix}$, where $x\notin dom(\Gamma)$.
		By using \runa{Ref read}, we get $[\mbox{ref}\;e^{p'}]^{p}\begin{Bmatrix} ^v/_x \end{Bmatrix}$.

		\item[\runa{Ref write}] Here $q=[e_1^{p'}\;:=\;e_2^{p''}]^{p}$, and $q\begin{Bmatrix} ^v/_x \end{Bmatrix}=[e_1^{p'}\;:=\;e_2^{p''}]^{p}\begin{Bmatrix} ^v/_x \end{Bmatrix}$.
		By the induction hypothesis, we have $\Gamma;\Pi\vdash e_1^{p'}\begin{Bmatrix} ^v/_x \end{Bmatrix}$ and $\Gamma;\Pi\vdash e_2^{p''}\begin{Bmatrix} ^v/_x \end{Bmatrix}$, where $x\notin dom(\Gamma)$.
		By using \runa{Ref write}, we get $[e_1^{p'}\;:=\;e_2^{p''}]^{p}\begin{Bmatrix} ^v/_x \end{Bmatrix}$.
	\end{description}
\end{proof}
\fi

\begin{lemma}[History]\label{lemma:His}
	If 
	$$env\vdash\left\langle e^{p'},w,sto,p\right\rangle\rightarrow\left\langle v,w',sto',(L,V),p''\right\rangle$$
		and $x^{p_1}\in dom(w')\backslash dom(w)$ then $x^{p_1}\notin fv(e)$
\end{lemma}
\begin{proof}
	The proof proceeds by induction on the height of the derivation tree for $env\vdash\left\langle e^{p'},w,sto,p\right\rangle\rightarrow\left\langle v,w',sto',(L,V),p''\right\rangle$.
\end{proof}

\begin{lemma}[Strengthening]\label{lemma:Strength}
	If $\Gamma,x^{p'}:T_1;\Pi\vdash e^{p}:T$ and $x\notin fv(e)$, then $\Gamma;\Pi\vdash e^{p}:T$
\end{lemma}
\begin{proof}
	The proof proceeds by induction on the height of the derivation tree for $\Gamma;\Pi\vdash e^{p}:T$.
\end{proof}

\begin{theorem}[Soundness of type system]
	Suppose $e^p$ is an occurrence where
	\begin{itemize}
		\item $\Gamma,\Pi\vdash e^p : T$, and 
		\item $env\vdash\left\langle e^p,w,sto,p'\right\rangle\rightarrow\left\langle v,w',sto',(L,V),p''\right\rangle$
	\end{itemize}
	and that $(w,env)\models\Gamma$.
	Then we have that:
	\begin{itemize}
		\item $\Gamma,\Pi\vdash v : T$
		\item $(w',env)\models\Gamma$
		\item $(env,(L,V))\models (\Gamma,T)$
	\end{itemize}
\end{theorem}
\begin{proof}
	The proof proceeds by induction on the height for the derivation tree for $env\vdash\left\langle e^p,w,sto,p'\right\rangle\rightarrow\left\langle v,w,sto,L,V,p\right\rangle$ and $\Gamma,\Pi\vdash e^p:T$
	In the base case we have the \runa{Cons} and \runa{Var} rule:
	\begin{description}
		\item[\runa{Cons}] Here $e^p=c^p$, where
			\begin{itemize}
				\item $\Gamma,\Pi\vdash c^p : (\emptyset,\emptyset)$, and 
				\item $env\vdash\left\langle c^p,w,sto,p'\right\rangle\rightarrow\left\langle c,w',sto',(\emptyset,\emptyset),p\right\rangle$
			\end{itemize}
			and $(w,env)\models\Gamma$.
			This case is immediate, since there are no extensions to $w$, $env$, or $\Gamma$.
			The type also agrees with the dependency pair, where we then get:
			\begin{itemize}
				\item $\Gamma,\Pi\vdash c : (\emptyset,\emptyset)$
				\item $(w,env)\models\Gamma$
				\item $(env,(\emptyset,\emptyset))\models (\Gamma,(\emptyset,\emptyset))$
			\end{itemize}

		\item[\runa{Var}] Here $e^p=x^p$, where
			\begin{itemize}
				\item $\Gamma,\Pi\vdash x^p : T\sqcup (\{x^p\},\emptyset)$, and 
				\item $env\vdash\left\langle x^p,w,sto,p'\right\rangle\rightarrow\left\langle v,w',sto',(\emptyset,\emptyset),p\right\rangle$
			\end{itemize}
			and $(w,env)\models\Gamma$.
			This case is immediate, since there are no extensions to $w$, $env$, or $\Gamma$, where we then get:
			\begin{itemize}
				\item $\Gamma,\Pi\vdash v : T$
				\item $(w,env)\models\Gamma$
				\item $(env,(L,V)\models (\Gamma,T)$
			\end{itemize}
	\end{description}

	Next, follows the induction step:
	\begin{description}
		\item[\runa{Abs}] Here $e^p=[\lambda\;x\;e_1^{p'}]^p$, where
			\begin{itemize}
				\item $\Gamma,\Pi\vdash [\lambda\;x\;e^{p'}]^p : T_1\rightarrow T_2$, and 
				\item $env\vdash\left\langle [\lambda\;x\;e^{p'}]^p,w,sto,p'\right\rangle\rightarrow\left\langle \left\langle x,e^{p'},env\right\rangle,w',sto',(\emptyset,\emptyset),p\right\rangle$
			\end{itemize}
			and $(w,env)\models\Gamma$.

			As there is no extension to $w$ and $env$, and the dependency pair is $(\emptyset,\emptyset)$, we then get:
			\begin{itemize}
				\item $(w,env)\models\Gamma$
				\item $(env,(\emptyset,\emptyset)\models (\Gamma,T)$
			\end{itemize}
			The only step left is to type the value $v$.
			Since we know that the value $v$ is a closure, then the type rule we need it \runa{Closure}.
			We know that both the \runa{Abs} and \runa{Closure} type rules both have the abstraction type, and we know that the \runa{Abs} rule is of the form:
			\begin{figure}[H]
				\setlength\tabcolsep{8pt}
				\begin{tabular}{l}
					\InfName{Abs}\\[0.2cm]
						\inference[]
						{\Gamma,x^{p'}:T_1;\Pi\vdash  e^{p}:T_2}
						{\Gamma;\Pi\vdash  [\lambda\;x.e^{p}]^{p'}:T_1\rightarrow T_2}\\
				\end{tabular}
			\end{figure}
			And the \runa{Closure} rule is of the form:
			\begin{figure}[H]
				\setlength\tabcolsep{8pt}
				\begin{tabular}{l}
					\runa{Closure}\\[0.4cm]
						\inference[]
							{
								\Gamma;\Pi\vdash env \\
								\Gamma,x^{p}:T_1;\Pi\vdash e^{p'}:T_2
							}
							{\Gamma;\Pi\vdash \left\langle x^{p}, e^{p'}, env \right\rangle^{p''}:T_1'\rightarrow T_2'}\\
				\end{tabular}
			\end{figure}
			It is immediate to see that the type of the conclusion should be $T_1\rightarrow T_2$ and the type of the second premise should be $T_2$.
			Furthermore we also know that $x^{p'}=x^{p}$, and as such $T_1=T_1'$.
			Lastly is the first premise, $\Gamma;\Pi\vdash env$, which simple state that $\Gamma$ agrees with $env$, which we have from $(env,w)\models\Gamma$.

		\item[\runa{App}] Here $e^p=[e_1^{p'}\;e_2^{p''}]^p$, where
			\begin{itemize}
				\item $\Gamma,\Pi\vdash [e_1^{p'}\;e_2^{p''}]^p : T,$, and 
				\item $env\vdash\left\langle [e_1^{p'}\;e_2^{p''}]^p,w,sto,p'\right\rangle\rightarrow\left\langle v,w',sto',(L,V),p\right\rangle$
			\end{itemize}
			and $(w,env)\models\Gamma$.
			Where, by the \runa{App} semantics rule we have:
			\begin{figure}[H]
				\setlength\tabcolsep{8pt}
				\begin{tabular}{l}
					\InfName{App}\\[0.2cm]
					\inference[]
						{env \vdash \left\langle e_1^{p'},sto,w,p \right\rangle \rightarrow \left\langle v',w_1, sto_1,(L_1,V_2),p' \right\rangle &\\
						env \vdash \left\langle e_2^{p''},w_1, sto_1,p' \right\rangle \rightarrow \left\langle v'',w_2, sto_2,(L_2,V_2),p'' \right\rangle &\\
						env[x\mapsto v''] \vdash \left\langle e^{p_1},w_2, sto_2, p'' \right\rangle \rightarrow \left\langle v,w', sto',(L_3,V_3),p_1 \right\rangle}
						{env\vdash \left\langle [e_1^{p'}\;e_2^{p''}]^{p},sto,w,p_3 \right\rangle \rightarrow \left\langle v,sto',w',(L,V),p \right\rangle}\\
					Where $v=\left\langle x,e^{p_1},env\right\rangle$, $L=L_1\cup L_2\cup L_3$, and $V=V_1\cup V_2\cup V_3$\\[1cm]
				\end{tabular}
			\end{figure}
			We need to show for: \runa{1} $(w',env)\models\Gamma$, \runa{2} $\Gamma;\Pi\vdash v:T$, and \runa{3} $((L,V),env)\models(\Gamma,T)$.
			\begin{description}
				\item[\runa{1}] From \cref{def:EnvAgree}, for environment agreement, we have two cases:
					\todo[inline]{This needs to be extended, such that the argument also holds for locations}
					\begin{itemize}
						\item If $x^{p_2}\in dom(w')\cap dom(w)$, then it follows the premises from \cref{def:EnvAgree}.
						\item If $x^{p_3}\in dom(w')\backslash dom(w)$, then from \cref{lemma:His}, we have $x\notin fv(e^{p})$ and as such $(w',env)\models\Gamma$ still holds since $x^{p_3}\notin dom(\Gamma)$.
					\end{itemize}
				\item[\runa{2}] Due to the type rule \runa{App}, we have:
					\begin{figure}[H]
						\setlength\tabcolsep{8pt}
						\begin{tabular}{l}
							\runa{App}\\[0.2cm]
								\inference[]
								{
									\Gamma;\Pi\vdash e_1^{p'}:T_1\rightarrow T_2 &\\
									\Gamma;\Pi\vdash e_2^{p''}:T_1
								}
								{\Gamma;\Pi\vdash [e_1^{p'} \; e_2^{p''}]^{p}:T_2}\\
						\end{tabular}
					\end{figure}
					And per induction hypothesis, we have:
					\begin{description}
						\item[\runa{*1}] $\Gamma,\Pi\vdash v':T_1\rightarrow T_2$
						\item[\runa{*2}] $\Gamma,\Pi\vdash v'':T_1$
					\end{description}
					Where we then need to show that $\Gamma,\Pi\vdash v:T_2$ where $v=\left\langle x,e^{p_1},env\right\rangle$, which get concluded by \runa{Closure}:
					\begin{figure}[H]
						\setlength\tabcolsep{8pt}
						\begin{tabular}{l}
							\runa{Closure}\\[0.4cm]
							\inference[]
							{
								\Gamma;\Pi\vdash env \\
								\Gamma,x^{p'_1}:T_1;\Pi\vdash e^{p_1}:T_2
							}
							{\Gamma;\Pi\vdash \left\langle x^{p'_1}, e^{p_1}, env \right\rangle:T_1\rightarrow T_2}\\[1cm]
						\end{tabular}
					\end{figure}
					Since $\Gamma;\Pi\vdash env$, then we lastly also need to show that $\Gamma,x^{p'_1}:T_1;\Pi\vdash env[x\mapsto v]$.
					By the induction hypothesis, we have $\Gamma,x^{p'_1};\Pi\vdash v:T_2$, and by strengthening, \cref{lemma:Strength}, we have $\Gamma;\Pi\vdash v:T_2$, since $v$ is instantiated we know that $x\in dom(env)$ then $x\notin fv(v)$.
				\item[\runa{3}] $((L,V),env)\models(\Gamma,T)$
			\end{description}
			

		\item[\runa{Let}] Here $e^p=[\mbox{let}\;x\;e_1^{p'}\;e_2^{p''}]^p$, where
			\begin{itemize}
				\item $\Gamma,\Pi\vdash [\mbox{let}\;x\;e_1^{p'}\;e_2^{p''}]^p : T,$, and 
				\item $env\vdash\left\langle [\mbox{let}\;x\;e_1^{p'}\;e_2^{p''}]^p,w,sto,p'\right\rangle\rightarrow\left\langle v,w',sto',(L,V),p\right\rangle$
			\end{itemize}
			and $(w,env)\models\Gamma$.
			We must show that:
			\begin{itemize}
				\item $\Gamma,\Pi\vdash v : T$
				\item $(w',env)\models\Gamma$
				\item $(env,(L,V))\models (\Gamma,T)$
			\end{itemize}
			To do this, we need to analyse the premises, where in the semantics we have:
			\begin{figure}[H]
				\setlength\tabcolsep{8pt}
				\begin{tabular}{l}
					\InfName{Let}\\[0.2cm]
						\inference[]
						{env\vdash \left\langle e_1^{p'},sto,w,p_1 \right\rangle \rightarrow \left\langle v_1,sto'',w'',(L',V'),p' \right\rangle &\\
						env[x\mapsto v_1]\vdash \left\langle e_2^{p''},sto',w_3,p' \right\rangle \rightarrow \left\langle v,sto',w',(L,V),p'' \right\rangle}
						{env\vdash \left\langle [\mbox{let}\;x\;e_1^{p'}\;e_2^{p''}]^{p},sto,w,p_1 \right\rangle \rightarrow \left\langle v,sto',w',(L,V),p \right\rangle}\\
						Where $w_3=w''[x^{p'}\mapsto(L',V')]$\\
				\end{tabular}
			\end{figure}

			In the type system, we have to let rules, \runa{Let-1} and \runa{Let-2}, which differs in the typing of the first premise, namely when the value is a location.
			Thus, \runa{Let-1} is for when $v_1=\loc$ which corresponds when the type is $(\delta,\kappa)$ and $\kappa\neq\emptyset$, and \runa{Let-2} for other cases.

			When $v_1=\loc$, we have the following type rule
			\begin{figure}[H]
				\setlength\tabcolsep{8pt}
				\begin{tabular}{l}
					\runa{Let-1}\\[0.2cm]
						\inference[]
							{\Gamma;\Pi\vdash e_1^{p'}:(\delta,\kappa) &\\
							\Gamma,x^{p'}:(\delta,\kappa\cup\{x\});\Pi\vdash e_2^{p''}:T}
							{\Gamma;\Pi\vdash [\mbox{let}\; x \; e_1^{p'} \; e_2^{p''}]^{p}:T}\\[0.3cm]
						Where $\kappa\neq\emptyset$\\
				\end{tabular}
			\end{figure}
			For the first premise we can get $(w'',env)\models\Gamma$, as the dependency function is only extended.
			If we know $(env,(L',V'))\models(\Gamma,(\delta,\kappa))$, we can then then get $\Gamma;\Pi\vdash\loc:(\delta,\kappa)$.
			Since the type is $(\delta,\kappa)$, we know that the type is either from \runa{Var}, \runa{Ref}, or \runa{Ref read} in $e_1^{p''}$.

			In the second premise, we have $(w_3,env[x\mapsto v_1])\models\Gamma$, since $x^{p'}\notin dom(\Gamma)$.
			We can then also get $(w_3,env[x\mapsto v_1])\models(\Gamma,x^{p'}:(\delta,\kappa\cup\{x\}))$, since $(env,(L',V'))\models(\Gamma,(\delta,\kappa))$, and $x$ is and alias $\loc$.
			
			Lastly, we can the get:
			\begin{itemize}
				\item $\Gamma,\Pi\vdash v : T$,
				\item $(w',env)\models\Gamma$, and
				\item $(env,(L,V))\models (\Gamma,T)$
			\end{itemize}
			And the conclusion follows immediately.
			\bigskip

			When $v_1\neq\loc$, we have the following type rule:
			\begin{figure}[H]
				\setlength\tabcolsep{8pt}
				\begin{tabular}{l}
					\runa{Let-2}\\[0.2cm]
						\inference[]
							{\Gamma;\Pi\vdash e_1^{p'}:T_1 &\\
							\Gamma,x^{p'}:T_1;\Pi\vdash e_2^{p''}:T}
							{\Gamma;\Pi\vdash [\mbox{let}\; x \; e_1^{p'} \; e_2^{p''}]^{p}:T}\\
				\end{tabular}
			\end{figure}
			The proof follows similarly for the case where $v_1=\loc$.


		\item[\runa{Let rec}] Here $e^p=[\mbox{let rec}\;f\;e_1^{p'}\;e_2^{p''}]^p$

		\item[\runa{Case}] Here $e^p=$

		\item[\runa{Match}] Here $e^p=$

		\item[\runa{Ref}] Here $e^p=$

		\item[\runa{Ref read}] Here $e^p=$

		\item[\runa{Ref write}] Here $e^p=$
	\end{description}
\end{proof}
\end{document}
