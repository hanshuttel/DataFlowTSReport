\documentclass[../../master.tex]{subfiles}
\begin{document}	
\section{Collection Semantics}\label{App:ColSem}
\begin{figure}[H]
	\setlength\tabcolsep{8pt}
	\begin{tabular}{l}
		\runa{Const}\\[0.2cm]
			\inference[]{}
				{env\vdash \left\langle c^{p'},sto,w,p \right\rangle \rightarrow \left\langle c,sto,w,(\emptyset,\emptyset),p' \right\rangle}\\[1cm]
			
		\runa{Var}\\[0.2cm]
			\inference[]{}
				{env\vdash \left\langle x^{p'},sto,w,p \right\rangle \rightarrow \left\langle v,sto,w,(L,V\cup\{x^{p'},x^{p''}\}),p' \right\rangle}\\
				Where $env(x)=v$, $p''=\inf_{p} (x,w)$, and $w(x^{p''})=(L,V)$\\[1cm]

		\runa{Abstraction}\\[0.2cm]
			\inference[]{}
				{env\vdash \left\langle \left[\lambda\;x.e^{p'}\right]^{p''},sto,w,p \right\rangle \rightarrow \left\langle v,sto,w,(\emptyset,\emptyset),p'' \right\rangle}\\
			Where $v=\left\langle x,e^{p'},env\right\rangle$\\[1cm]

		\runa{App}\\[0.2cm]
			\inference[]
				{env \vdash \left\langle e_1^{p'},sto,w,p \right\rangle \rightarrow \left\langle v,sto',w',(L,V),p' \right\rangle &\\
				env \vdash \left\langle e_2^{p''},sto',w',p' \right\rangle \rightarrow \left\langle v',sto'',w'',(L',V'),p'' \right\rangle &\\
				env'[x\mapsto v'] \vdash \left\langle e^{p_1},sto'',w_3,p'' \right\rangle \rightarrow \left\langle v'',sto_3,w_4,(L'',V''),p_1 \right\rangle}
				{env\vdash \left\langle \left[e_1^{p'}\;e_2^{p''}\right]^{p_3},sto,w,p \right\rangle \rightarrow \left\langle v'',sto_3,w_4,(L\cup L'',V\cup V''),p_3 \right\rangle}\\
			Where $v=\left\langle x,e^{p_1},env'\right\rangle$ and $w_3=w''[x^{p''}\mapsto (L',V')]$\\[1cm]

		\runa{App const}\\[0.2cm]
			\inference[]
				{env \vdash \left\langle e_1^{p'},sto,w,p \right\rangle \rightarrow \left\langle c,sto',w',(L,V),p' \right\rangle &\\
				env \vdash \left\langle e_2^{p''},sto',w',p' \right\rangle \rightarrow \left\langle v,sto'',w'',(L',V'),p'' \right\rangle}
				{env\vdash \left\langle \left[e_1^{p'}\;e_2^{p''}\right]^{p_3},sto,w,p \right\rangle \rightarrow \left\langle v',sto'',w'',(L\cup L',V\cup V'),p_3 \right\rangle}\\
			Where $apply(c,v)=v'$\\[1cm]

		\runa{App rec}\\[0.2cm]
			\inference[]
				{env \vdash \left\langle e_1^{p'},sto,w,p \right\rangle \rightarrow \left\langle v,sto',w',(L,V),p' \right\rangle &\\
				env \vdash \left\langle e_2^{p''},sto',w',p' \right\rangle \rightarrow \left\langle v',sto'',w'',(L',V'),p'' \right\rangle &\\
				env'[x\mapsto v', f\mapsto\left\langle x,f,e,env'\right\rangle] \vdash \left\langle e^{p_1},sto'',w_3,p'' \right\rangle \rightarrow \left\langle v'',sto_3,w_4,(L'',V''),p_1 \right\rangle}
				{env\vdash \left\langle \left[e_1^{p'}\;e_2^{p''}\right]^{p_3},sto,w,p \right\rangle \rightarrow \left\langle v'',sto_3,w_4,(L\cup L'',V\cup V''),p_3 \right\rangle}\\
			Where $v=\left\langle x,f,e^{p_1},env'\right\rangle$ and $w_3=w''[x^{p''}\mapsto (L',V')]$\\
	\end{tabular}
	\label{fig:InfDV}
\end{figure}

\begin{figure}[H]
	\setlength\tabcolsep{8pt}
	\begin{tabular}{l}
		\runa{Let}\\[0.2cm]
			\inference[]
			{env\vdash \left\langle e_1^{p'},sto,w,p \right\rangle \rightarrow \left\langle v,sto',w',(L,V),p' \right\rangle &\\
			env[x\mapsto v]\vdash \left\langle e_2^{p''},sto',w'',p' \right\rangle \rightarrow \left\langle v',sto'',w_3,(L',V'),p'' \right\rangle}
			{env\vdash \left\langle \left[\mbox{let}\;x\;e_1^{p'}\;e_2^{p''}\right]^{p_3},sto,w,p \right\rangle \rightarrow \left\langle v',sto'',w_3,(L',V'),p_3 \right\rangle}\\
		Where $p_1$ is fresh and $w''=w'[x^{p_1}\mapsto(L,V)]$\\[1cm]

		\runa{Let rec}\\[0.2cm]
			\inference[]
			{env\vdash \left\langle e_1^{p'},sto,w,p \right\rangle \rightarrow \left\langle v,sto',w',(L,V),p' \right\rangle &\\
			env\left[f\mapsto\left\langle x,f,e_1^{p'},env'\right\rangle\right]\vdash \left\langle e_2^{p''},sto',w'',p' \right\rangle \rightarrow \left\langle v',sto'',w_3,(L',V'),p'' \right\rangle}
			{env\vdash \left\langle \left[\mbox{let rec}\;f\;e_1^{p'}\;e_2^{p''}\right]^{p_3},sto,w,p \right\rangle \rightarrow \left\langle v',sto'',w_3,(L',V'),p_3 \right\rangle}\\
		Where $v=\left\langle x,e_1^{p'},env'\right\rangle$, $p_2$ is fresh, and $w''=w'[f^{p_2}\mapsto(L,V)]$\\[1cm]

		\runa{Case}\\[0.2cm]
			\inference[]
				{env \vdash \left\langle e^{p'},sto,w,p \right\rangle \rightarrow \left\langle v,sto',w',(L,V),p' \right\rangle &\\
				env \vdash \left\langle (v,(L,V),\pi^{p''}),sto',w',p' \right\rangle \rightarrow \left\langle v',sto'',w'',(L',V'),p'' \right\rangle}
				{env\vdash \left\langle \left[\mbox{case}\;e^{p'}\;\pi^{p''}\right]^{p_3},sto,w,p \right\rangle \rightarrow \left\langle v',sto'',w'',(L\cup L',V\cup V'),p_3 \right\rangle}\\[1cm]

		\runa{match 1}\\[0.2cm]
			\inference[]
				{env\sigma \vdash \left\langle e^{p'},sto,w',p \right\rangle \rightarrow \left\langle v,sto',w'',(L,V),p' \right\rangle}
				{env\vdash \left\langle (v,(L,V),(s\;e^{p'})\pi^{p''}),sto,w',p \right\rangle \rightarrow \left\langle v,sto',w'',(L,V),p'' \right\rangle}\\
			Where $match(v,s)=\sigma$, $\sigma\neq\perp$, $p_1$ is fresh,\\
			$match_w(s,p_1,(L,V))=\phi$, and $w'=w\phi$\\[1cm]

		\runa{match 2}\\[0.2cm]
			\inference[]
				{env\sigma \vdash \left\langle e^{p'},sto,w',p \right\rangle \rightarrow \left\langle v,sto',w'',(L,V),p' \right\rangle}
				{env\vdash \left\langle (v,(L,V),(s\;e^{p'})),sto,w',p \right\rangle \rightarrow \left\langle v,sto',w'',(L,V),p'' \right\rangle}\\
			Where $match(v,s)=\sigma$, $\sigma\neq\perp$, $p_1$ is fresh,\\
			$match_w(s,p_1,(L,V))=\phi$, and $w'=w\phi$\\[1cm]

		\runa{match $\perp$}\\[0.2cm]
			\inference[]
				{env \vdash \left\langle (v,(L,V),\pi^{p''}),sto,w,p \right\rangle \rightarrow \left\langle v,sto',w',(L,V),p'' \right\rangle}
				{env\vdash \left\langle (v,(L,V),(s\;e^{p'})\pi^{p''}),sto,w,p \right\rangle \rightarrow \left\langle v,sto',w',(L,V),p'' \right\rangle}\\
			Where $match(v,s)=\perp$\\[1cm]
	\end{tabular}
	\label{fig:InfDV}
\end{figure}

\begin{figure}[H]
	\setlength\tabcolsep{8pt}
	\begin{tabular}{l}
		\runa{Ref}\\[0.2cm]
			\inference[]
				{env \vdash \left\langle e^{p'},sto,w,p \right\rangle \rightarrow \left\langle v,sto',w',(L,V),p' \right\rangle}
				{env\vdash \left\langle \left[\mbox{ref}\;e^{p'}\right]^{p''},sto,w,p \right\rangle \rightarrow \left\langle \loc,sto'',w'',(\emptyset,\emptyset),p'' \right\rangle}\\
			Where $\loc=next$, $sto''=sto'[next\mapsto new(\loc),\loc\mapsto v]$,\\
			$p_1$ is fresh, and $w''=w'[\loc^{p_1}\mapsto (L,V)]$\\[1cm]

		\runa{Ref-read}\\[0.2cm]
			\inference[]
				{env \vdash \left\langle e^{p'},sto,w,p \right\rangle \rightarrow \left\langle \loc,sto',w',(L,V),p' \right\rangle}
				{env\vdash \left\langle \left[!e^{p'}\right]^{p''},sto,w,p \right\rangle \rightarrow \left\langle v,sto',w',(L\cup\{\loc^{p''}\},V),p'' \right\rangle}\\
			Where $sto'(\loc)=v$\\[1cm]

		\runa{Ref-write}\\[0.2cm]
			\inference[]
				{env \vdash \left\langle e_1^{p'},sto,w,p \right\rangle \rightarrow \left\langle \loc,sto',w',(L,V),p' \right\rangle &\\
				env \vdash \left\langle e_2^{p''},sto',w',p' \right\rangle \rightarrow \left\langle v,sto'',w'',(L',V'),p'' \right\rangle}
				{env\vdash \left\langle \left[e_1^{p'}:=e_2^{p''}\right]^{p_3},sto,w,p \right\rangle \rightarrow \left\langle (),sto_3,w_3,(L,V),p_3 \right\rangle}\\
				Where $sto_3=sto''[\loc\mapsto v]$, $p_2$ is fresh, $p_4=inf_{p'}(\loc,w')$\\
				$w_3=w''[\loc^{p_2}\mapsto(L'\cup\{\loc^{p_4}\},V')]$
	\end{tabular}
	\label{fig:InfDV}
\end{figure}

\subsection{Pattern matching}
ReScript pattern matching matches the first expression, $e_1$, with each case in the order they are defined in.
Here, we define the function $match:Val \times Pat \rightarrow (\Var \rightharpoonup \Exp)$, where $Pat$ is the set of patterns.

Note that the $match$ rules also holds if $\pi$ is empty, i.e., it does not contain more cases.

The $match(v,s)=\sigma$ function, where $\sigma:\Var \rightharpoonup \Exp$ is a substition.
We defined the function inductively as follows:

\begin{align*}
	match(n,n) &= id\\
	match(b,b) &= id\\
	match(e,x) &= [x \mapsto e]\\
	%match((k,v), k) &= [k \mapsto v]\\
	match(\{l_i=e_i\}^n_{i \in I},\{l_i\}^n_{i \in I}) &= [l_i \mapsto e_i, \sigma_{i+1}]_{i \in I}\\
	match(e,\_) &=\epsilon\\
	match(\_,p) &= F
\end{align*}

\paragraph{number and boolean}
Matching of numbers and booleans are an equality match, so those cases returns the identity.

\paragraph{variables}
Variable pattern matching instantiates the pattern, by binding the expression to the variable.

\paragraph{patterns}
Matching a record matches on all patterns in the expression $e$, where $I$ denote a finite amount of records fields.
Since there are multiple record fields, each of those need to be instantiated
$\sigma_i=match(\{l_i=e_i\}^n_{i \in I},\{l_i\}^n_{i \in I})$

\paragraph{wildcard and fail}
The last two patterns to match are the wildcard and fail cases.
The wildcard accepts any input $e$ and gives an emtpy sybstitution, the fail case just return a false boolean value, since it were an unsuccessful match.


\subsection{Extending $w$}
Similarly to the pattern matching function, we define a function that extends the dependency function for binding pattern bindings to it liveness information.
This is similarly defined, where $match_w(s,p,(L,V))=\phi$ is a function that returns an extension $\phi$.
The $match_w$ function can thus be defined by:
\begin{align}
	match_w(s,p,(L,V))) =
	\left\{\begin{matrix}
		[x^p\mapsto (L,V)] & \mbox{if}\; s=x\\ 
		[] & \mbox{otherwise}
	\end{matrix}\right.
\end{align}

\end{document}
